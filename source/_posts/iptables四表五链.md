---
title: iptables四表五链
date: 2020-05-26 10:04:59
categories: iptables
keywords: 四表五链
description: 四表五链
---

# iptables四表五链

iptables是一种数据包过滤很强大的工具，可以用于添加、编辑、删除规则。这些规则是在做数据包过滤决定时，防火墙所遵循和组成的规则。这些规则是存储在数据包过滤表中，而这些表集成在Linux内核中。在数据包过滤表中，规则被分组放在所谓的链(chain)中。

## 四表

- raw：优先级最高，设置raw时一般是为了不再让iptables做数据包的链接跟踪处理，提高性能
- mangle：用于对特定数据包的修改
- nat：用于nat功能（端口映射，地址映射等）
- filter：一般的过滤功能

默认表是filter（没有指定表的时候就是filter表)

### 优先级

表的处理优先级：`raw > mangle > nat > filter`

RAW 表只使用在PREROUTING链和OUTPUT链上,因为优先级最高，从而可以对收到的数据包在连接跟踪前进行处理。一但用户使用了RAW表,在某个链 上,RAW表处理完后,将跳过NAT表和 ip_conntrack处理,即不再做地址转换和数据包的链接跟踪处理了。

 RAW表可以应用在那些不需要做nat的情况下，以提高性能。如大量访问的web服务器，可以让80端口不再让iptables做数据包的链接跟踪处理，以提高用户的访问速度。

## 五链

链是穿插在各个表之间，与表组成的就是规则。

- PREROUTING：数据包进入路由表之前
-  INPUT：通过路由表后目的地为本机，处理入站数据包
-  FORWARD：通过路由表后，目的地不为本机，处理转发数据包
-  OUTPUT：由本机产生，向外转发，处理出站数据包
-  POSTROUTIONG：发送到网卡接口之前

如下图：

![1590461504602](/uploads/iptables/1590461504602.png)

## 表与链对应关系

 iptables中表和链的对应关系如下：

![1590461552065](/uploads/iptables/1590461552065.png)

## 数据包流程

一个数据包到达时,是怎么依次穿过各个链和表的（图）。 

![1590461589291](/uploads/iptables/1590461589291.png)

### 分析

#### 基本步骤

1. 数据包到达网络接口，比如 eth0。 
2. 进入 raw 表的 PREROUTING 链，这个链的作用是赶在连接跟踪之前处理数据包。 
3. 如果进行了连接跟踪，在此处理。 
4. 进入 mangle 表的 PREROUTING 链，在此可以修改数据包，比如 TOS 等。 
5. 进入 nat 表的 PREROUTING 链，可以在此做DNAT，但不要做过滤。 
6. 路由决策，看是交给本地主机还是转发给其它主机。 

##### 交给其他主机

**到了这里我们就得分两种不同的情况进行讨论了，一种情况就是数据包要转发给其它主机，这时候它会依次经过：** 

7. 进入 mangle 表的 FORWARD 链，这里也比较特殊，这是在第一次路由决策之后，在进行最后的路由决策之前，我们仍然可以对数据包进行某些修改。 
8. 进入 filter 表的 FORWARD 链，在这里我们可以对所有转发的数据包进行过滤。需要注意的是：经过这里的数据包是转发的，方向是双向的。 
9. 进入 mangle 表的 POSTROUTING 链，到这里已经做完了所有的路由决定，但数据包仍然在本地主机，我们还可以进行某些修改。 
10. 进入 nat 表的 POSTROUTING 链，在这里一般都是用来做 SNAT ，不要在这里进行过滤。 
11. 进入出去的网络接口。完毕。 

##### 交给本机

**另一种情况是，数据包就是发给本地主机的，那么它会依次穿过：** 

7. 进入 mangle 表的 INPUT 链，这里是在路由之后，交由本地主机之前，我们也可以进行一些相应的修改。 
8. 进入 filter 表的 INPUT 链，在这里我们可以对流入的所有数据包进行过滤，无论它来自哪个网络接口。 
9. 交给本地主机的应用程序进行处理。 
10. 处理完毕后进行路由决定，看该往那里发出。 
11. 进入 raw 表的 OUTPUT 链，这里是在连接跟踪处理本地的数据包之前。 
12. 连接跟踪对本地的数据包进行处理。 
13. 进入 mangle 表的 OUTPUT 链，在这里我们可以修改数据包，但不要做过滤。 
14. 进入 nat 表的 OUTPUT 链，可以对防火墙自己发出的数据做 NAT 。 
15. 再次进行路由决定。 
16. 进入 filter 表的 OUTPUT 链，可以对本地出去的数据包进行过滤。 
17. 进入 mangle 表的 POSTROUTING 链，同上一种情况的第9步。注意，这里不光对经过防火墙的数据包进行处理，还对防火墙自己产生的数据包进行处理。 
18. 进入 nat 表的 POSTROUTING 链，同上一种情况的第10步。 
19. 进入出去的网络接口。完毕。